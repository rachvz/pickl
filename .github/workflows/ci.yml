name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    name: Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linting
        run: npm run lint

  verify-hooks:
    name: Verify Git Hooks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.x'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Verify hooks installation
        run: npm run verify:hooks

      - name: Verify hook line endings
        run: |
          echo "Checking hook file line endings..."
          if grep -q $'\r' .husky/pre-commit; then
            echo "‚ùå Error: .husky/pre-commit has CRLF line endings"
            echo "   Run 'npm run format' to fix line endings"
            exit 1
          fi
          if grep -q $'\r' .husky/commit-msg; then
            echo "‚ùå Error: .husky/commit-msg has CRLF line endings"
            echo "   Run 'npm run format' to fix line endings"
            exit 1
          fi
          echo "‚úÖ Hook files have correct LF line endings"

      - name: Test pre-commit hook behavior
        run: |
          echo "üß™ Testing pre-commit hook on feature branch..."

          # Configure git user for CI
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"

          # Ensure we're on a proper branch (CI might be in detached HEAD)
          git checkout -B temp-ci-branch

          # Create test file and branch
          echo "// test file" > test-hook-verification.js
          git add test-hook-verification.js
          git checkout -b test-hook-branch

          # Test hook allows commits on feature branch
          if git commit -m "test: verify hook allows commits on feature branch"; then
            echo "‚úÖ Hook correctly allows commits on feature branch"
          else
            echo "‚ùå Hook incorrectly blocked commit on feature branch"
            exit 1
          fi

          # Clean up
          git checkout temp-ci-branch
          git branch -D test-hook-branch
          rm -f test-hook-verification.js

  test:
    name: Test (Node ${{ matrix.node-version }})
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: ['22.x', '23.x']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Run tests
        run: npm test

      - name: Generate HTML report
        if: always()
        run: npm run report

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-node-${{ matrix.node-version }}
          path: |
            test-results/
            cucumber-report.html
          retention-days: 30

      - name: Upload screenshots on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: screenshots-node-${{ matrix.node-version }}
          path: test-results/**/*.png
          retention-days: 7

      - name: Upload videos on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: videos-node-${{ matrix.node-version }}
          path: test-results/**/*.webm
          retention-days: 7
